#cloud-config
package_update: true
package_upgrade: true

write_files:
  - path: /etc/rancher/k3s/config.yaml
    content: |
      server: {{.ServerURL}}
      token: {{.Token}}
      {{range $k, $v := .Labels}}
      node-label:
        - "{{$k}}={{$v}}"
      {{end}}

runcmd:
  # Install k3s agent
  - |
    curl -sfL https://get.k3s.io | sh -s - agent
  # Wait for k3s to be ready
  - until kubectl get nodes; do sleep 5; done
