#!/usr/bin/env python3
import sys
import yaml
import os
from pathlib import Path

if len(sys.argv) != 3:
    print(f"Usage: {sys.argv[0]} <kubeconfig-file> <name>")
    sys.exit(1)

src_file = sys.argv[1]
new_name = sys.argv[2]
dest_file = Path.home() / ".kube" / "config"

# Check source file exists
if not os.path.exists(src_file):
    print(f"File not found: {src_file}")
    sys.exit(1)

# Load source kubeconfig
try:
    with open(src_file, 'r') as f:
        src_config = yaml.safe_load(f)
except Exception as e:
    print(f"Invalid kubeconfig file: {e}")
    sys.exit(1)

# Get the first context
if not src_config.get('contexts'):
    print(f"No contexts found in kubeconfig")
    sys.exit(1)

old_ctx = src_config['contexts'][0]['name']
old_cluster = src_config['contexts'][0]['context']['cluster']
old_user = src_config['contexts'][0]['context']['user']

# Rename everything to new_name
for ctx in src_config['contexts']:
    if ctx['name'] == old_ctx:
        ctx['name'] = new_name
        ctx['context']['cluster'] = new_name
        ctx['context']['user'] = new_name

for cluster in src_config.get('clusters', []):
    if cluster['name'] == old_cluster:
        cluster['name'] = new_name

for user in src_config.get('users', []):
    if user['name'] == old_user:
        user['name'] = new_name

src_config['current-context'] = new_name

# Load or create destination config
if dest_file.exists():
    with open(dest_file, 'r') as f:
        dest_config = yaml.safe_load(f)
    if not dest_config:
        dest_config = {
            'apiVersion': 'v1',
            'kind': 'Config',
            'preferences': {},
            'clusters': [],
            'contexts': [],
            'users': []
        }
else:
    dest_config = {
        'apiVersion': 'v1',
        'kind': 'Config',
        'preferences': {},
        'clusters': [],
        'contexts': [],
        'users': []
    }

# Remove existing entries with same name
dest_config['clusters'] = [c for c in dest_config.get('clusters', []) if c['name'] != new_name]
dest_config['contexts'] = [c for c in dest_config.get('contexts', []) if c['name'] != new_name]
dest_config['users'] = [u for u in dest_config.get('users', []) if u['name'] != new_name]

# Add new entries
dest_config['clusters'].extend(src_config.get('clusters', []))
dest_config['contexts'].extend(src_config.get('contexts', []))
dest_config['users'].extend(src_config.get('users', []))
dest_config['current-context'] = new_name

# Create .kube directory if needed
dest_file.parent.mkdir(parents=True, exist_ok=True)

# Write merged config
with open(dest_file, 'w') as f:
    yaml.dump(dest_config, f, default_flow_style=False, sort_keys=False)

os.chmod(dest_file, 0o600)

print(f"Added '{new_name}' to kubeconfig")
print(f"\nUse it with: kubectl config use-context {new_name}")

print(f"Added '{new_name}' to kubeconfig")
print(f"\nUse it with: kubectl config use-context {new_name}")
