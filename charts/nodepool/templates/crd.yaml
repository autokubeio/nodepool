apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nodepools.hcloud.autokube.io
  labels:
    {{- include "scale.labels" . | nindent 4 }}
spec:
  group: hcloud.autokube.io
  names:
    kind: NodePool
    listKind: NodePoolList
    plural: nodepools
    shortNames:
    - np
    singular: hcloudnodepool
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            required:
            - provider
            properties:
              provider:
                type: string
                enum: [hetzner]
                default: hetzner
                description: Cloud provider (currently supports hetzner)
              hetznerConfig:
                type: object
                description: Hetzner Cloud specific configuration (required when provider is hetzner)
                properties:
                  serverType:
                    type: string
                    description: Hetzner Cloud server type (e.g., cx11, cpx21)
                  location:
                    type: string
                    description: Hetzner Cloud location (e.g., nbg1, fsn1, hel1)
                  image:
                    type: string
                    description: OS image to use for nodes (e.g., ubuntu-22.04)
                  network:
                    type: string
                    description: Hetzner Cloud network ID or name to attach nodes to
              serverType:
                type: string
                description: "[DEPRECATED] Use hetznerConfig.serverType instead"
              location:
                type: string
                description: "[DEPRECATED] Use hetznerConfig.location instead"
              image:
                type: string
                description: "[DEPRECATED] Use hetznerConfig.image instead"
              minNodes:
                type: integer
                minimum: 0
                default: 1
                description: Minimum number of nodes in the pool
              maxNodes:
                type: integer
                minimum: 1
                default: 10
                description: Maximum number of nodes in the pool
              targetNodes:
                type: integer
                minimum: 0
                description: Desired number of nodes
              cloudInit:
                type: string
                description: Cloud-init configuration for node initialization
              bootstrap:
                type: object
                description: Bootstrap configuration for automatic cluster joining
                properties:
                  type:
                    type: string
                    enum: [kubeadm, k3s, talos, rke2, rancher]
                    description: Cluster type (kubeadm, k3s, talos, rke2, rancher)
                  autoGenerateToken:
                    type: boolean
                    description: Automatically generate bootstrap token for kubeadm
                  kubernetesVersion:
                    type: string
                    default: "1.29"
                    description: Kubernetes version to install (e.g., "1.29", "1.30")
                  apiServerEndpoint:
                    type: string
                    description: Override API server endpoint
                  tokenSecretRef:
                    type: object
                    description: Reference to secret containing bootstrap token
                    properties:
                      name:
                        type: string
                      key:
                        type: string
                  k3sConfig:
                    type: object
                    description: K3s specific configuration
                    properties:
                      serverURL:
                        type: string
                      tokenSecretRef:
                        type: object
                        properties:
                          name:
                            type: string
                          key:
                            type: string
                  talosConfig:
                    type: object
                    description: Talos specific configuration
                    properties:
                      controlPlaneEndpoint:
                        type: string
                      configSecretRef:
                        type: object
                        properties:
                          name:
                            type: string
                          key:
                            type: string
                  rke2Config:
                    type: object
                    description: RKE2/Rancher specific configuration
                    properties:
                      serverURL:
                        type: string
                      tokenSecretRef:
                        type: object
                        properties:
                          name:
                            type: string
                          key:
                            type: string
              sshKeys:
                type: array
                items:
                  type: string
                description: SSH key IDs or names to add to the nodes
              labels:
                type: object
                additionalProperties:
                  type: string
                description: Additional labels to apply to cloud provider resources
              network:
                type: string
                description: "[DEPRECATED] Use hetznerConfig.network instead"
              autoScalingEnabled:
                type: boolean
                default: true
                description: Enable automatic scaling based on cluster load
              firewallRules:
                type: array
                description: Custom firewall rules to apply
                items:
                  type: object
                  required:
                    - port
                  properties:
                    port:
                      type: string
                      description: Port or port range (e.g., "80", "8080:8090")
                    protocol:
                      type: string
                      default: tcp
                      enum: [tcp, udp]
                      description: Protocol (tcp or udp)
                    description:
                      type: string
                      description: Human-readable description
              runCmd:
                type: array
                description: Commands to run after node initialization
                items:
                  type: string
              scaleUpThreshold:
                type: integer
                minimum: 1
                default: 5
                description: Number of pending pods to trigger scale up
              scaleDownThreshold:
                type: integer
                minimum: 0
                maximum: 100
                default: 30
                description: CPU utilization percentage to trigger scale down
          status:
            type: object
            properties:
              currentNodes:
                type: integer
                description: Current number of nodes in the pool
              readyNodes:
                type: integer
                description: Number of ready nodes
              nodes:
                type: array
                items:
                  type: string
                description: List of node names in the pool
              lastScaleTime:
                type: string
                format: date-time
                description: Last time the pool was scaled
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                    reason:
                      type: string
                    message:
                      type: string
                    lastTransitionTime:
                      type: string
                      format: date-time
              phase:
                type: string
                description: Current phase of the node pool
    subresources:
      status: {}
    additionalPrinterColumns:
    - name: Provider
      type: string
      jsonPath: .spec.provider
    - name: ServerType
      type: string
      jsonPath: .spec.hetznerConfig.serverType
    - name: Location
      type: string
      jsonPath: .spec.hetznerConfig.location
    - name: Min
      type: integer
      jsonPath: .spec.minNodes
    - name: Max
      type: integer
      jsonPath: .spec.maxNodes
    - name: Current
      type: integer
      jsonPath: .status.currentNodes
    - name: Ready
      type: integer
      jsonPath: .status.readyNodes
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
